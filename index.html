<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Referral System</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    input, button { padding: 10px; margin: 10px; font-size: 16px; }
    #leaderboard { margin-top: 30px; }
    table { width: 50%; margin: auto; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; }
  </style>
</head>
<body>
  <h1>Referral System</h1>
  <p>Enter your Discord username (example: Whate#2332)</p>
  <input type="text" id="username" placeholder="Your Discord username">
  <button onclick="register()">Register</button>

  <p id="refLink"></p>
  <p id="stats"></p>

  <h2>Leaderboard</h2>
  <div id="leaderboard"></div>

<script>
  const baseURL = window.location.origin; // same Vercel project

  async function register() {
    const username = document.getElementById("username").value;
    if (!username) return alert("Enter your username!");

    const res = await fetch(baseURL + "/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });
    const data = await res.json();

    if (data.error) return alert(data.error);

    document.getElementById("refLink").innerText =
      "Your referral link: " + baseURL + "/?ref=" + encodeURIComponent(username);

    updateStats(username);
    loadLeaderboard();
  }

  async function updateStats(username) {
    const res = await fetch(baseURL + "/api/leaderboard");
    const all = await res.json();
    const user = all.find(u => u.user === username);
    if (user) {
      document.getElementById("stats").innerText =
        "Total Referrals: " + user.referrals;
    }
  }

  async function loadLeaderboard() {
    const res = await fetch(baseURL + "/api/leaderboard");
    const data = await res.json();

    let html = "<table><tr><th>User</th><th>Referrals</th></tr>";
    data.forEach(row => {
      html += `<tr><td>${row.user}</td><td>${row.referrals}</td></tr>`;
    });
    html += "</table>";

    document.getElementById("leaderboard").innerHTML = html;
  }

  loadLeaderboard();
</script>
</body>
</html>
